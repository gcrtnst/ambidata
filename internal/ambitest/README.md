# ambitest
ambitest は、ambidata ライブラリの自動テストコードです。

Go の標準テスト機能 (`go test`) がモックサーバーを用いるのに対し、ambitest は実際の Ambient サーバーに接続して、ライブラリとサーバー間の連携を含めた動作をテストします。

## 実行準備
ambitest を実行する前に、以下の手順で Ambient 上にテスト環境を準備してください。

> [!WARNING]
> ambitest は実行中にチャネル内のデータを **削除** します。
> 誤って運用中のデータを削除・変更してしまうリスクを避けるため、普段利用しているアカウントは使用せず、**テスト用のアカウントとチャネルを必ず作成してください。**

1.  テスト用アカウントの作成

    Ambient 上で、[新規ユーザー登録](https://ambidata.io/usr/signup.html) を行います。

2.  テスト用チャネルの作成

    作成したテスト用アカウントでログインし、新しいチャネルを1つ作成します。

3.  テスト用チャネルの設定

    作成したテスト用チャネルの「チャネル設定」ページで、以下の項目を設定してください。

    | 項目名             | 設定値               | 例                                             |
    | ------------------ | -------------------- | ---------------------------------------------- |
    | チャネル名         | 空でない任意の文字列 | `ambitest`                                     |
    | 説明               | 空でない任意の文字列 | `test channel for github.com/gcrtnst/ambidata` |
    | データー1～8の名前 | 空でない任意の文字列 | `d1`, `d2`, ... `d8`                           |
    | データー1～8の色   | 任意                 | デフォルト                                     |
    | 緯度               | 任意                 | `35.689`                                       |
    | 経度               | 任意                 | `139.692`                                      |
    | Embed Code         | 空でない任意の文字列 | `https://example.com/`                         |

4.  デバイスキーの設定

    Ambient の「デバイスキー設定」ページにて、テスト用チャネルにデバイスキーを1つ設定します。

    - デバイスキー: 空でない任意の文字列 (例: `02:00:00:00:00:01`)

5.  ボードの作成

    Ambient の「チャネル一覧」ページを開き、作成したテスト用チャネルのチャネル名を1回だけクリックしてください。これにより、チャネルに対応するボードが作成されます。

6.  環境変数の設定

    ambitest を実行するには、以下の環境変数を設定する必要があります。上記の手順で作成・設定したアカウントおよびチャネルの情報を設定してください。

    **⚠警告**: ambitest はチャネル内のデータを削除するため、誤ってテスト用ではないチャネルやアカウントの情報を設定しないよう十分ご注意ください。

    | 環境変数            | 説明                                    |
    | ------------------- | --------------------------------------- |
    | `AMBITEST_CH`       | テスト用チャネルのチャネルID            |
    | `AMBITEST_USERKEY`  | テスト用アカウントのユーザーキー        |
    | `AMBITEST_READKEY`  | テスト用チャネルのリードキー            |
    | `AMBITEST_WRITEKEY` | テスト用チャネルのライトキー            |
    | `AMBITEST_DEVKEY`   | テスト用チャネルに設定したデバイスキー  |

## 使い方

### 基本的な実行方法
この README.md が置かれているディレクトリをカレントディレクトリとして、次のコマンドを実行します。

```bash
go run .
```

デフォルトでは基本テストのみを実行します。拡張テストを含む全てのテストを実行するには、次のように `-all` 引数を付けてください。

```bash
go run . -all
```

ambitest は以下のような形式でテスト結果を標準出力します。

```
PASS TestAAA
FAIL TestBBB
PASS TestCCC
FAIL
```

全テストが成功した場合、最終行は `PASS` となり、exit code は 0 となります。いずれかのテストが失敗した場合、最終行は `FAIL` となり、exit code は 1 となります。

## 開発者向け情報
`ambitest` に新しいテストケースを追加・開発する際のガイドラインです。

### テストの種類と使い分け
ambidata ライブラリのテストは、目的に応じて以下の3種類に分類されます。新しいテストケースを追加する際は、テストの目的を考慮し、どの種類に追加するのが適切か判断してください。

- `go test`: ライブラリ単体の機能テスト。モックサーバーを使用。
- ambitest 基本テスト: ライブラリが実際の Ambient サーバーと基本的な通信ができるかのテスト。
- ambitest 拡張テスト: 大量データの送信テストや、API の境界条件テストなど、レートリミットを考慮し、頻繁な実行を避けるべきテスト。

### テストケースの追加手順

1.  テスト関数の実装

    テスト関数は以下の形式で実装してください。`*T` はテストのコンテキストを提供するオブジェクトです。

    ```go
    func TestXXX(t *T)
    ```

    テスト関数内では、`*T` が提供する以下のメソッドを使用してテスト結果を記録します。
    - `t.Fail()`: テストを失敗としてマークします。以降の処理は継続されます。
    - `t.Error(args ...any)` / `t.Errorf(format string, args ...any)`: ログメッセージを出力し、テストを失敗としてマークします。
    - `t.Log(args ...any)` / `t.Logf(format string, args ...any)`: テスト実行に関するログメッセージを出力します。テストの成否には影響しません。

    環境変数から取得された情報は `t.Config` フィールドから取得できます。`Config` 構造体は以下のようになっています。

    ```go
    type Config struct {
    	Ch       string
    	UserKey  string
    	ReadKey  string
    	WriteKey string
    	DevKey   string
    }
    ```

    テスト関数内で `(*ambidata.Sender).Send` や `(*ambidata.Sender).SendBulk` を使用して Ambient にデータを送信する場合、Ambient の API 制限（チャネルごとに最低5秒間隔）を遵守するため、データを送信する処理の前後に以下のヘルパー関数を呼び出してください。
    - `t.PostWait()`: 前回の送信から5秒経過するまで待機。送信処理の直前に呼び出します。
    - `t.PostDone()`: 今回の送信完了時刻を記録。送信処理が完了した直後に呼び出します。

2.  `list.go` への登録

    実装したテスト関数を `list.go` 内の `TestList` スライスに追加します。エントリは、テスト名（文字列）、テスト関数への参照、拡張テストかどうかのフラグ (`bool`) の3つの要素で構成されます。

    ```go
    // 追加例
    var TestList = []TestEntry{
    	// ... 既存のテスト ...
    	{"TestXXX", TestXXX, false},    // 基本テスト
    	{"TestYYY", TestYYY, true},     // 拡張テスト
    }
    ```
